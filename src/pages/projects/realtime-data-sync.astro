---
import Layout from "../../layouts/Layout.astro";
import { ArrowLeft } from "@lucide/astro";
---

<Layout
  title="Real-time Data Synchronization Platform | Ban Tran"
  description="Enterprise-scale data synchronization system handling millions of events daily with CDC pipelines and stream processing"
>
  <!-- Back Navigation -->
  <div class="mb-8">
    <a
      href="/projects"
      class="text-accent inline-flex items-center gap-2 hover:underline"
    >
      <ArrowLeft size="1rem" />
      Back to Projects
    </a>
  </div>

  <!-- Project Header -->
  <section class="mb-12">
    <h1 class="mb-4 text-4xl font-bold lg:text-5xl">
      <span class="fancy-highlight"
        >Real-time Data Synchronization Platform</span
      >
    </h1>
    <div class="mb-6 flex flex-wrap gap-2">
      <span class="badge badge-accent">Kafka</span>
      <span class="badge badge-accent">Debezium</span>
      <span class="badge badge-accent">Confluent Schema Registry</span>
      <span class="badge badge-accent">Materialize</span>
      <span class="badge badge-accent">Flink</span>
      <span class="badge badge-accent">RisingWave</span>
    </div>
    <p class="text-muted text-lg">
      Built enterprise-scale data synchronization system handling millions of
      events daily. Implemented CDC pipelines with Kafka and stream processing
      for real-time data transformations.
    </p>
    <!-- comment out this section to finish the blog post first-->
    <!-- <div
      class="mt-6 rounded-xl border border-blue-500/20 bg-blue-500/10 p-6 backdrop-blur-xl dark:border-blue-400/20 dark:bg-blue-400/10"
    >
      <h3 class="mb-2 text-lg font-semibold">
        ðŸ“– Read the Full Technical Deep Dive
      </h3>
      <p class="text-muted mb-4">
        Learn about the architecture, challenges, and solutions behind this
        platform in our detailed blog post.
      </p>
      <a
        href="/blog/realtime-data-sync"
        class="btn btn-accent inline-flex items-center gap-2"
      >
        Read the Blog Post
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M9 5l7 7-7 7"></path>
        </svg>
      </a>
    </div> -->
  </section>

  <!-- Results & Impact -->
  <section class="mb-12">
    <h2 class="mb-6">
      <span class="fancy-highlight">Results & Impact</span>
    </h2>
    <div
      class="rounded-xl border border-white/20 bg-white/10 p-6 backdrop-blur-xl"
    >
      <div class="grid gap-6 md:grid-cols-3">
        <div class="text-center">
          <div class="text-accent mb-2 text-4xl font-bold">5M+</div>
          <div class="text-muted text-sm">Events Per Day</div>
        </div>
        <div class="text-center">
          <div class="text-accent mb-2 text-4xl font-bold">&lt;100ms</div>
          <div class="text-muted text-sm">Average Latency</div>
        </div>
        <div class="text-center">
          <div class="text-accent mb-2 text-4xl font-bold">99.9%</div>
          <div class="text-muted text-sm">Uptime SLA</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Live System Status -->
  <section class="mb-12">
    <div class="mb-6 flex items-center justify-between">
      <h2>
        <span class="fancy-highlight">Live System Status</span>
      </h2>
      <button
        id="refreshBtn"
        class="btn btn-sm btn-accent light-mode-subtle"
        onclick="fetchConnectorStatus()"
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
          ></path>
        </svg>
        Refresh
      </button>
    </div>

    <div
      class="mb-4 rounded-lg border border-gray-300 bg-gray-100 p-3 dark:border-white/20 dark:bg-white/10"
    >
      <p class="text-sm text-gray-700 dark:text-gray-300">
        <svg
          class="mr-2 inline-block h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
          ></path>
        </svg>
        <strong>Note:</strong> For security reasons, all connector names are displayed
        in encrypted format.
      </p>
    </div>

    <div id="statusContainer" class="space-y-4">
      <div
        class="flex items-center justify-center rounded-xl border border-white/20 bg-white/10 p-8 backdrop-blur-xl"
      >
        <div class="flex items-center gap-3">
          <div
            class="border-accent h-8 w-8 animate-spin rounded-full border-4 border-t-transparent"
          >
          </div>
          <p class="text-muted">Loading connector status...</p>
        </div>
      </div>
    </div>

    <div id="errorContainer" class="hidden">
      <div
        class="rounded-xl border border-red-500/20 bg-red-500/10 p-6 backdrop-blur-xl"
      >
        <p class="font-semibold text-red-400">
          Failed to load connector status
        </p>
        <p class="mt-2 text-sm text-red-300" id="errorMessage"></p>
        <p class="mt-2 text-xs text-red-200">
          Note: This may be due to CORS restrictions. The API needs to allow
          requests from this domain.
        </p>
      </div>
    </div>
  </section>

  <!-- Back Navigation -->
  <div class="mt-12">
    <a
      href="/projects"
      class="text-accent inline-flex items-center gap-2 hover:underline"
    >
      <ArrowLeft size="1rem" />
      Back to Projects
    </a>
  </div>

  <script>
    let accessToken: string | null = null;
    let tokenExpiry: number = 0;

    async function getAccessToken(): Promise<string> {
      // Check if we have a valid token
      if (accessToken && Date.now() < tokenExpiry) {
        return accessToken;
      }

      const response = await fetch(
        "https://auth.s2.technology/realms/bantnd/protocol/openid-connect/token",
        {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({
            grant_type: "client_credentials",
            client_id: "helper",
            client_secret: "rzrY0RQmJbIHyZdOxCJf5071686VGzBS",
          }),
        },
      );

      if (!response.ok) {
        throw new Error("Failed to get access token");
      }

      const data = await response.json();
      accessToken = data.access_token;
      if (!accessToken) {
        throw new Error("Access token not found in response");
      }
      // Set expiry to 5 minutes before actual expiry for safety
      tokenExpiry = Date.now() + (data.expires_in - 300) * 1000;
      return accessToken;
    }

    async function fetchConnectorStatus() {
      const statusContainer = document.getElementById("statusContainer");
      const errorContainer = document.getElementById("errorContainer");
      const refreshBtn = document.getElementById("refreshBtn");

      if (!statusContainer || !errorContainer || !refreshBtn) return;

      // Show loading state
      statusContainer.innerHTML = `
        <div class="flex items-center justify-center rounded-xl border border-white/20 bg-white/10 p-8 backdrop-blur-xl">
          <div class="flex items-center gap-3">
            <div class="h-8 w-8 animate-spin rounded-full border-4 border-accent border-t-transparent"></div>
            <p class="text-muted">Loading connector status...</p>
          </div>
        </div>
      `;
      errorContainer.classList.add("hidden");
      refreshBtn.setAttribute("disabled", "true");

      try {
        // Get access token
        const token = await getAccessToken();

        // Fetch connector status
        const response = await fetch(
          "https://s2.technology/bantnd/health/kafka-connectors",
          {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          },
        );

        if (!response.ok) {
          throw new Error(`API returned status ${response.status}`);
        }

        const connectors = await response.json();

        // Sort connectors: RUNNING first, then others
        const sortedConnectors = Object.entries(connectors).sort(
          ([, a]: any, [, b]: any) => {
            if (a.state === "RUNNING" && b.state !== "RUNNING") return -1;
            if (a.state !== "RUNNING" && b.state === "RUNNING") return 1;
            return 0;
          },
        );

        // Display connectors
        if (sortedConnectors.length === 0) {
          statusContainer.innerHTML = `
            <div class="rounded-xl border border-white/20 bg-white/10 p-6 backdrop-blur-xl">
              <p class="text-center text-muted">No connectors found</p>
            </div>
          `;
        } else {
          const runningCount = sortedConnectors.filter(
            ([, c]: any) => c.state === "RUNNING",
          ).length;
          const totalCount = sortedConnectors.length;

          statusContainer.innerHTML = `
            <div class="mb-4 rounded-xl border border-white/20 bg-white/10 p-4 backdrop-blur-xl">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-sm text-muted">System Status</p>
                  <p class="text-2xl font-bold">
                    ${
                      runningCount === totalCount
                        ? '<span class="text-green-400">All Systems Operational</span>'
                        : '<span class="text-yellow-400">Some Issues Detected</span>'
                    }
                  </p>
                </div>
                <div class="text-right">
                  <p class="text-3xl font-bold text-accent">${runningCount}/${totalCount}</p>
                  <p class="text-sm text-muted">Connectors Running</p>
                </div>
              </div>
            </div>
            
            <div class="grid gap-3 md:grid-cols-2 lg:grid-cols-3">
              ${sortedConnectors
                .map(([name, connector]: any) => {
                  const isRunning = connector.state === "RUNNING";
                  const stateColor = isRunning
                    ? "text-green-400"
                    : "text-red-400";
                  const borderColor = isRunning
                    ? "border-green-500/20"
                    : "border-red-500/20";
                  const bgColor = isRunning ? "bg-green-500/5" : "bg-red-500/5";

                  return `
                  <div class="rounded-xl border ${borderColor} ${bgColor} p-4 backdrop-blur-xl">
                    <div class="mb-2 flex items-start justify-between">
                      <div class="flex items-center gap-2">
                        <div class="h-2 w-2 rounded-full ${isRunning ? "bg-green-400" : "bg-red-400"} animate-pulse"></div>
                        <span class="text-xs uppercase tracking-wider ${stateColor} font-semibold">
                          ${connector.state}
                        </span>
                      </div>
                      <span class="rounded bg-white/10 px-2 py-1 text-xs text-muted">
                        ${connector.type}
                      </span>
                    </div>
                    <p class="text-sm font-medium break-all">
                      ${name}
                    </p>
                  </div>
                `;
                })
                .join("")}
            </div>
          `;
        }
      } catch (error) {
        console.error("Error fetching connector status:", error);
        errorContainer.classList.remove("hidden");
        const errorMessage = document.getElementById("errorMessage");
        if (errorMessage) {
          errorMessage.textContent =
            error instanceof Error ? error.message : "Unknown error occurred";
        }
        statusContainer.innerHTML = "";
      } finally {
        refreshBtn.removeAttribute("disabled");
      }
    }

    // Make function available globally for the refresh button
    (window as any).fetchConnectorStatus = fetchConnectorStatus;

    // Fetch status on page load
    fetchConnectorStatus();
  </script>
</Layout>
